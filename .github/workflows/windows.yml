name: Windows CI

on: [push, pull_request]

jobs:
  msvc-qmake-build:
  
    strategy:
      matrix:
        vs: ['2022']
        msvc_arch: ['x64']

    runs-on: windows-2022

    steps:
    - uses: actions/checkout@v4
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        arch: 'win64_msvc2019_64'
        version: '6.7.2'
    - name: Build
      shell: cmd
      run: |
        set VS=${{ matrix.vs }}
        set VCVARS="C:\Program Files (x86)\Microsoft Visual Studio\%VS%\Enterprise\VC\Auxiliary\Build\vcvarsall.bat"
        if not exist %VCVARS% set VCVARS="C:\Program Files\Microsoft Visual Studio\%VS%\Enterprise\VC\Auxiliary\Build\vcvarsall.bat"
        call %VCVARS% ${{ matrix.msvc_arch }}
        qmake pineapple-pictures.pro
        nmake
        nmake clean
        windeployqt --verbose=2 --no-quick-import --no-translations --no-opengl-sw --no-system-d3d-compiler --skip-plugin-types tls,networkinformation release\ppic.exe
    - uses: actions/upload-artifact@v4
      with:
        name: windows-msvc2022-qt6.7.2-qmake-package
        path: release/*

  msvc-cmake-build:
  
    strategy:
      matrix:
        vs: ['2022']
        msvc_arch: ['x64']

    runs-on: windows-2022

    steps:
    - uses: actions/checkout@v4
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        arch: 'win64_msvc2019_64'
        version: '6.5.3'
    - name: Build
      shell: cmd
      run: |
        set PWD=%cd%
        set VS=${{ matrix.vs }}
        set VCVARS="C:\Program Files (x86)\Microsoft Visual Studio\%VS%\Enterprise\VC\Auxiliary\Build\vcvarsall.bat"
        if not exist %VCVARS% set VCVARS="C:\Program Files\Microsoft Visual Studio\%VS%\Enterprise\VC\Auxiliary\Build\vcvarsall.bat"
        call %VCVARS% ${{ matrix.msvc_arch }}
        cmake -Bbuild . -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="%PWD%\build\"
        cmake --build build --config Release
        cmake --build build --config Release --target=install
        windeployqt --verbose=2 --no-quick-import --no-translations --no-opengl-sw --no-system-d3d-compiler --skip-plugin-types tls,networkinformation build\bin\ppic.exe
    - uses: actions/upload-artifact@v4
      with:
        name: windows-msvc2022-qt6.5.3-cmake-package
        path: build/bin/*
